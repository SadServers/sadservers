<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SadServers - Scenarios</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background: #f8fafc; }
    .navbar { margin-bottom: 0; }
    .badge-pill { padding: .45em .75em; }
    .table thead th { vertical-align: middle; }
    .tag-button { border-radius: 999px; }
  </style>
</head>
<body>
  <nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a href="/" class="navbar-brand mb-0 h1">SadServers</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="/scenarios">Scenarios</a></li>
          <li class="nav-item"><a class="nav-link" href="/accounts/dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/ranking">Ranking</a></li>
          <li class="nav-item"><a class="nav-link" href="/pricing">Pricing</a></li>
        </ul>
        <span class="navbar-text navbar-nav ml-auto">
          <a href="/accounts/login">Log In</a> - <a href="/accounts/signup">Sign Up</a>
        </span>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-5">
    <div class="py-3 text-center">
      <h2 class="h4 mb-1">SadServers Troubleshooting Scenarios</h2>
      <div class="row justify-content-center">
        <div class="col-md-3 col-6 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body text-center">
              <div class="text-uppercase small text-muted">Total Scenarios</div>
              <div class="h5 mb-0" id="statTotal">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-6 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body text-center">
              <div class="text-uppercase small text-muted">Fix</div>
              <div class="h5 mb-0" id="statFix">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-6 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body text-center">
              <div class="text-uppercase small text-muted">Build</div>
              <div class="h5 mb-0" id="statBuild">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-6 mb-2">
          <div class="card shadow-sm h-100">
            <div class="card-body text-center">
              <div class="text-uppercase small text-muted">Learn</div>
              <div class="h5 mb-0" id="statLearn">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-12 col-md-6 mb-2 mb-md-0">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text bg-white border-end-0">üîç</span>
              </div>
              <input type="search" class="form-control border-start-0" id="search" placeholder="Search title, description, slug or tag">
            </div>
          </div>
          <div class="col-auto">
            <select id="pageSize" class="form-control">
              <option value="15">15 per page</option>
              <option value="30">30 per page</option>
              <option value="60">60 per page</option>
            </select>
          </div>
          <div class="col-auto d-flex gap-2">
            <button id="toggleCollapse" class="btn btn-outline-secondary mr-2">Expand all</button>
            <button id="clearSearch" class="btn btn-outline-secondary">Clear</button>
          </div>
        </div>
        <div class="d-flex flex-wrap align-items-center mt-3" id="tagList"></div>
      </div>
    </div>

    <div class="mb-2 text-secondary" id="resultCount">Loading scenarios...</div>

    <div class="table-responsive">
      <table class="table table-hover table-striped">
        <thead class="thead-light">
          <tr>
            <th style="width: 60px;">#</th>
            <th>Scenario</th>
            <th style="width: 80px;">Time</th>
            <th style="width: 120px;">Level</th>
            <th style="width: 120px;">Type</th>
            <th style="width: 120px;">Access</th>
            <th style="width: 160px;">Tags</th>
            <th style="width: 90px;" class="text-center">Info</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="empty" class="alert alert-secondary mt-3 d-none" role="alert">No scenarios match the current filters.</div>

    <div id="pagination" class="d-flex justify-content-center align-items-center gap-3 mt-3 d-none">
      <button id="prev" class="btn btn-outline-secondary mr-3">Previous</button>
      <span id="pageLabel" class="fw-semibold"></span>
      <button id="next" class="btn btn-primary ml-3">Next</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script>
    const allowedTags = [
      "advent2025",
      "apache",
      "bash",
      "c",
      "caddy",
      "clickhouse",
      "csv",
      "data processing",
      "disk volumes",
      "dns",
      "docker",
      "envoy",
      "etcd",
      "git",
      "golang",
      "gunicorn",
      "hack",
      "haproxy",
      "harbor",
      "hashicorp vault",
      "helm",
      "java",
      "jenkins",
      "json",
      "kubernetes",
      "linux-other",
      "mysql",
      "nginx",
      "node.js",
      "php",
      "podman",
      "postgres",
      "prometheus",
      "python",
      "rabbitmq",
      "redis",
      "sql",
      "sqlite",
      "ssh",
      "ssl",
      "supervisord",
      "systemd",
      "realistic",
      "interviews",
      "new",
      "pro",
      "business",
    ];
    const state = { data: [], filtered: [], page: 1, pageSize: 15, collapse: true, selectedTags: new Set(), allTags: [] };
    const searchInput = document.getElementById("search");
    const pageSizeSelect = document.getElementById("pageSize");
    const toggleCollapseBtn = document.getElementById("toggleCollapse");
    const clearSearchBtn = document.getElementById("clearSearch");
    const tableBody = document.getElementById("tableBody");
    const resultCount = document.getElementById("resultCount");
    const emptyState = document.getElementById("empty");
    const pagination = document.getElementById("pagination");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const pageLabel = document.getElementById("pageLabel");
    const tagList = document.getElementById("tagList");
    const statTotal = document.getElementById("statTotal");
    const statFix = document.getElementById("statFix");
    const statBuild = document.getElementById("statBuild");
    const statLearn = document.getElementById("statLearn");

    const escapeHtml = (value = "") =>
      String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");

    async function loadData() {
      try {
        const response = await fetch("scenario-index.json");
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        state.data = await response.json();
      } catch (error) {
        resultCount.textContent = "Could not load scenario-index.json. Run python generate_index.py and open with a local server from the scenarios directory.";
        emptyState.classList.remove("d-none");
        return;
      }
      const present = new Set(state.data.flatMap((item) => item.tags || []).map((tag) => tag.trim().toLowerCase()));
      state.allTags = allowedTags.filter((tag) => present.has(tag.toLowerCase()));
      renderTags();
      applyFilters();
      renderStats();
    }

    function renderTags() {
      tagList.innerHTML = state.allTags
        .map((tag) => {
          const active = state.selectedTags.has(tag.toLowerCase());
          const cls = active ? "btn btn-primary btn-sm tag-button mr-2 mb-2" : "btn btn-outline-secondary btn-sm tag-button mr-2 mb-2";
          return `<button class="${cls}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</button>`;
        })
        .join("");
      tagList.querySelectorAll("button").forEach((button) => {
        button.addEventListener("click", () => {
          const value = button.dataset.tag.toLowerCase();
          if (state.selectedTags.has(value)) state.selectedTags.delete(value); else state.selectedTags.add(value);
          renderTags();
          applyFilters();
        });
      });
    }

    function renderStats() {
      statTotal.textContent = state.data.length;
      statFix.textContent = state.data.filter((item) => (item.type || "").toLowerCase().includes("fix")).length;
      statBuild.textContent = state.data.filter((item) => (item.type || "").toLowerCase().includes("build")).length;
      statLearn.textContent = state.data.filter((item) => (item.type || "").toLowerCase().includes("learn")).length;
    }

    function matchesTags(item) {
      if (state.selectedTags.size === 0) return true;
      const tags = (item.tags || []).map((tag) => tag.toLowerCase());
      for (const tag of state.selectedTags) if (!tags.includes(tag)) return false;
      return true;
    }

    function applyFilters() {
      const term = searchInput.value.trim().toLowerCase();
      state.filtered = state.data.filter((item) => {
        const blob = `${item.title} ${item.description} ${item.slug} ${(item.tags || []).join(" ")} ${item.level || ""} ${item.type || ""} ${item.access || ""} ${item.readme || ""}`.toLowerCase();
        const matchesSearch = term ? blob.includes(term) : true;
        const tagMatch = matchesTags(item);
        return matchesSearch && tagMatch;
      });
      state.page = 1;
      render();
    }

    function render() {
      const total = state.filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
      if (state.page > totalPages) state.page = totalPages;
      const start = (state.page - 1) * state.pageSize;
      const items = state.filtered.slice(start, start + state.pageSize);
      tableBody.innerHTML = items.map((item, index) => rowTemplate(item, start + index + 1, !state.collapse)).join("");
      resultCount.textContent = `Showing ${items.length} of ${total} scenarios`;
      emptyState.classList.toggle("d-none", items.length > 0);
      pagination.classList.toggle("d-none", total <= state.pageSize);
      pageLabel.textContent = `Page ${state.page} of ${totalPages}`;
      prevBtn.disabled = state.page === 1;
      nextBtn.disabled = state.page === totalPages;
    }

    function rowTemplate(item, number, open) {
      const tags = (item.tags || []).map((tag) => `<span class="badge badge-pill badge-secondary mr-1 mb-1">${escapeHtml(tag)}</span>`).join("");
      const description = item.description || "No description yet.";
      const time = item.time || "";
      const level = item.level || "";
      const type = item.type || "";
      const access = item.access || "";
      const collapseId = `collapse-${item.slug}`;
      return `
        <tr>
          <th scope="row">${number}</th>
          <td><a href="${encodeURI(item.readme)}">${escapeHtml(item.title)}</a></td>
          <td>${escapeHtml(time)}</td>
          <td>${escapeHtml(level)}</td>
          <td>${escapeHtml(type)}</td>
          <td>${escapeHtml(access)}</td>
          <td>${tags}</td>
          <td class="text-center">
            <button class="btn btn-info btn-sm" data-toggle="collapse" data-target="#${collapseId}" aria-expanded="${open ? "true" : "false"}" aria-controls="${collapseId}">Info</button>
          </td>
        </tr>
        <tr id="${collapseId}" class="collapse ${open ? "show" : ""}">
          <td colspan="8" class="text-left bg-light">
            <div class="mb-2">${escapeHtml(description)}</div>
            <a class="btn btn-warning btn-sm" href="${encodeURI(item.readme)}">Open README</a>
          </td>
        </tr>
      `;
    }

    function setPage(delta) {
      const totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
      state.page = Math.min(totalPages, Math.max(1, state.page + delta));
      render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    searchInput.addEventListener("input", applyFilters);
    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = "";
      state.selectedTags = new Set();
      renderTags();
      applyFilters();
    });
    pageSizeSelect.addEventListener("change", (event) => { state.pageSize = Number(event.target.value); state.page = 1; render(); });
    toggleCollapseBtn.addEventListener("click", () => { state.collapse = !state.collapse; toggleCollapseBtn.textContent = state.collapse ? "Expand all" : "Collapse all"; render(); });
    prevBtn.addEventListener("click", () => setPage(-1));
    nextBtn.addEventListener("click", () => setPage(1));

    loadData();
  </script>
</body>
</html>
